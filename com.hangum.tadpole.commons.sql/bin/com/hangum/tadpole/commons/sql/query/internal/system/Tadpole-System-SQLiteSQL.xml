<?xml version="1.0" encoding="UTF-8" ?>
<!--
  Copyright (c) 2013 hangum.
  All rights reserved. This program and the accompanying materials
  are made available under the terms of the GNU Lesser Public License v2.1
  which accompanies this distribution, and is available at
  http://www.gnu.org/licenses/old-licenses/gpl-2.0.html
  
  Contributors:
      hangum - initial API and implementation
-->
<!--
- 시스템 사용자 정보 디비
CREATE TABLE tadpole_system (
	seq INTEGER PRIMARY KEY AUTOINCREMENT,
	name		VARCHAR(100) NOT NULL,
	major_version VARCHAR(50) NOT NULL,
	sub_version VARCHAR(50) NOT NULL,	
	information VARCHAR(2000) NOT NULL,
	create_time DATE DEFAULT (datetime('now','localtime'))
)


-사용자 그룹
CREATE TABLE user_group  (
	seq INTEGER PRIMARY KEY AUTOINCREMENT,
	name VARCHAR(60) NOT NULL,
	create_time DATE DEFAULT (datetime('now','localtime')),
	delYn CHAR(3) DEFAULT 'NO'
)

-사용자
-	user_type(admin, manager, user, guest) 
CREATE TABLE   users  (
	seq INTEGER PRIMARY KEY AUTOINCREMENT ,
	group_seq INTEGER NOT NULL, 
	email VARCHAR(60) NOT NULL,
	passwd VARCHAR(60) NOT NULL,
	name VARCHAR(60) NOT NULL,
	user_type VARCHAR(20) NOT NULL DEFAULT 'user',
	approval_yn VARCHAR(3) NOT NULL DEFAULT 'NO' ,
	create_time DATE DEFAULT (datetime('now','localtime')),
	delYn CHAR(3) DEFAULT 'NO',
	UNIQUE(email, user_type),
	FOREIGN KEY (group_seq) REFERENCES user_group  (seq) ON DELETE NO ACTION ON UPDATE NO ACTION
)

- 외부 사용자 디비(amazonRDS, ucloud db)
CREATE TABLE ext_account (
	seq INTEGER PRIMARY KEY AUTOINCREMENT ,
	user_seq INTEGER  NOT NULL,
	types VARCHAR(100) NOT NULL,
	name VARCHAR(1000) NOT NULL,
	value0 VARCHAR(1000) NOT NULL,
	value1 VARCHAR(1000),
	value2 VARCHAR(1000),
	value3 VARCHAR(1000),
	value4 VARCHAR(1000),
	value5 VARCHAR(1000),
	value6 VARCHAR(1000),
	value7 VARCHAR(1000),
	value8 VARCHAR(1000),
	value9 VARCHAR(1000),
	success VARCHAR(10),
	message VARCHAR(1000),
	create_time DATE DEFAULT (datetime('now','localtime')),
    delYn CHAR(3) DEFAULT 'NO',
    UNIQUE(user_seq, types, name),
    FOREIGN KEY (user_seq) REFERENCES users (seq) ON DELETE NO ACTION ON UPDATE NO ACTION
)

-사용자 디비
-// host, port는 sqlite는 값이 없으므로 not null에서 제외 했습니다.
CREATE TABLE user_db (
     seq INTEGER PRIMARY KEY AUTOINCREMENT ,
     user_seq INTEGER  NOT NULL,
     ext_seq INTEGER,
     operation_type VARCHAR(10) NOT NULL DEFAULT 'DEVELOP',
     types     	VARCHAR(50)  	NOT NULL,
     url			VARCHAR(2000)  	NOT NULL,
     db	VARCHAR(50)  	NOT NULL,
     group_name VARCHAR(50),
     display_name VARCHAR(50)  	NOT NULL,
     host		 VARCHAR(50) 	,
     port		 VARCHAR(10) ,
     locale	VARCHAR(10)		,
     passwd		 VARCHAR(500)  	,
     users		 VARCHAR(100) 	,
     is_profile VARCHAR(3) NOT NULL DEFAULT 'YES',
     profile_select_mill INTEGER(3) NOT NULL DEFAULT -1,
     question_dml VARCHAR(3) NOT NULL DEFAULT 'NO',
     is_readOnlyConnect VARCHAR(3) NOT NULL DEFAULT 'NO',
	 is_autocmmit VARCHAR(3) NOT NULL DEFAULT 'NO',
	 is_table_filter VARCHAR(3) NOT NULL DEFAULT 'NO',
	 table_filter_include VARCHAR(2000),
	 table_filter_exclude VARCHAR(2000),
     create_time DATE DEFAULT (datetime('now','localtime')),
     delYn CHAR(3) DEFAULT 'NO',
     ext1 VARCHAR(2000),
     ext2 VARCHAR(2000), 
     ext3 VARCHAR(2000),  
     ext4 VARCHAR(2000),  
     ext5 VARCHAR(2000),  
     ext6 VARCHAR(2000),  
     ext7 VARCHAR(2000),  
     ext8 VARCHAR(2000),  
     ext9 VARCHAR(2000),  
     ext10 VARCHAR(2000),  
     FOREIGN KEY (user_seq) REFERENCES users (seq) ON DELETE NO ACTION ON UPDATE NO ACTION,
     FOREIGN KEY (ext_seq) REFERENCES ext_account (seq) ON DELETE NO ACTION ON UPDATE NO ACTION
)

-사용자 디비의 RESOURCE SQL, ERD
CREATE TABLE user_db_resource (
     seq INTEGER PRIMARY KEY AUTOINCREMENT ,
     types VARCHAR(10) NOT NULL,
     user_seq INTEGER NOT NULL,
     db_seq INTEGER  NOT NULL,
     filename VARCHAR(2000)  NOT NULL,
     duration_mill INTEGER DEFAULT -1,
     execution_result CHAR(3) DEFAULT 'YES',
     create_time DATE DEFAULT (datetime('now','localtime')),
     delYn CHAR(3) DEFAULT 'NO',
     UNIQUE(types, user_seq, db_seq, filename),
     FOREIGN KEY (user_seq) REFERENCES users (seq) ON DELETE NO ACTION ON UPDATE NO ACTION,
     FOREIGN KEY (db_seq) REFERENCES user_db (seq) ON DELETE NO ACTION ON UPDATE NO ACTION
)

-사용자 디비의 실제 데이터 입력
CREATE TABLE user_db_resource_data (
     seq INTEGER PRIMARY KEY AUTOINCREMENT ,
     user_db_resource_seq INTEGER NOT NULL,
     datas VARCHAR(2000)  NOT NULL,
     FOREIGN KEY (user_db_resource_seq) REFERENCES user_db_resource (seq) ON DELETE NO ACTION ON UPDATE NO ACTION
)

-사용자 프리퍼런스 데이터
CREATE TABLE user_info_data (
	seq INTEGER PRIMARY KEY AUTOINCREMENT,
    user_seq INTEGER NOT NULL,
    db_seq INTEGER  NOT NULL,
    name VARCHAR(40) NOT NULL,
    value0 VARCHAR(2000),
    value1 VARCHAR(2000),
    value2 VARCHAR(2000),
    value3 VARCHAR(2000),
    value4 VARCHAR(2000),
    value5 VARCHAR(2000),
    FOREIGN KEY (user_seq) REFERENCES users (seq) ON DELETE NO ACTION ON UPDATE NO ACTION,
    FOREIGN KEY (db_seq) REFERENCES user_db (seq) ON DELETE NO ACTION ON UPDATE NO ACTION
)

- 사용자 쿼리 정보.
CREATE TABLE executed_sql_resource (
	 seq INTEGER PRIMARY KEY AUTOINCREMENT ,
     user_seq INTEGER NOT NULL,
     db_seq INTEGER  NOT NULL,
	 types VARCHAR(10) NOT NULL,
     startDateExecute DATE DEFAULT (datetime('now','localtime')),
     endDateExecute DATE DEFAULT (datetime('now','localtime')),
     row int default 0,
     result CHAR(3) DEFAULT 'YES',
     message VARCHAR(2000),
     create_time DATE DEFAULT (datetime('now','localtime')),
     delYn CHAR(3) DEFAULT 'NO',
     FOREIGN KEY (user_seq) REFERENCES users (seq) ON DELETE NO ACTION ON UPDATE NO ACTION,
     FOREIGN KEY (db_seq) REFERENCES user_db (seq) ON DELETE NO ACTION ON UPDATE NO ACTION
)

- 사용자 쿼리 내용.
CREATE TABLE executed_sql_resource_data (
     seq INTEGER PRIMARY KEY AUTOINCREMENT ,
     executed_sql_resource_seq INTEGER NOT NULL,
     datas VARCHAR(2000)  NOT NULL,
     FOREIGN KEY (executed_sql_resource_seq) REFERENCES executed_sql_resource (seq) ON DELETE NO ACTION ON UPDATE NO ACTION
)
 -->
<!DOCTYPE sqlMap      
    PUBLIC "-//ibatis.apache.org//DTD SQL Map 2.0//EN"      
    "http://ibatis.apache.org/dtd/sql-map-2.dtd">

<sqlMap namespace="Tadpole-System-SQLiteSQL">

	<!--
		============================================================================================================================ 
		user table이 있는 지 여부에 따라 시스템 테이블의 존재 유무를 가린다.
		============================================================================================================================
	 -->
	<select id="isUserTable" resultClass="java.lang.String">
		SELECT name 
		FROM sqlite_master
		WHERE 
			type = 'table' and 
			name = 'users'  
	</select>

</sqlMap>
